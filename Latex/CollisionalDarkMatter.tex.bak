% CollisionalDarkMatter.tex 
%
% Based in the LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% 
% Created by Keith T. Smith (Royal Astronomical Society)

% Change log
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{amssymb}	% Extra maths symbols
\usepackage{physics}

\usepackage{quotmark} %Temporal, en lo que soluciono las comillas.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

% Please keep new commands to a minimum, and use \newcommand not \def to avoid
% overwriting existing commands. Example:
%\newcommand{\pcm}{\,cm$^{-2}$}	% per cm-squared
\newcommand{\f}[1][t]{f(\vb*{r},\vb*{v};#1)}
\newcommand{\dens}[1][t]{\rho(\vb*{r};#1)}
\newcommand{\acce}[1][t]{\vb*{a}(\vb*{r};#1)}
\newcommand{\pot}[1][t]{\Phi(\vb*{r};#1)}

\newcommand{\rv}{\vb*{r},\vb*{v}}
\newcommand{\crosssection}{\langle \sigma v \rangle}
\newcommand{\toInt}[1]{\ensuremath{\lfloor#1\rceil}}
%TODO reemplazar los comandos por las verdaderas variables.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
%\title[Short title, max. 45 characters]{Simulating collisional dark matter using a Lattice Boltzmann method}

\title[Collisional lattice dynamics]{Lattice dynamics for a collisional dark matter fluid}
%\title[Collisional lattice dynamics]{Lattice dynamics for a collisional stellar fluid}



% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor
\author[J. A. Acevedo-Barroso \& J. E. Forero-Romero]{
Javier A. Acevedo-Barroso,$^{1}$\thanks{E-mail: ja.acevedo12@uniandes.edu.co}
Jaime E. Forero-Romero,$^{1}$\thanks{E-mail: je.forero@uniandes.edu.co}
\\
% List of institutions
$^{1}$Departamento de F\'isica, Universidad de los Andes, Cra. 1 No. 18A-10 Edificio Ip, CP 111711, Bogot\'a, Colombia\\
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2019}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
%TODO Volver a revisar el abstract al final. Debe ser un solo parrafo.
Usually, dark matter is simulated with N-body schemes that sample the phase space in order to solve the Poisson-Vlasov equation. This approach is heavily motivated by the $\Lambda$CMD cosmology, in which dark matter is a cold collisionless fluid.
However, there is some evidence pointing towards self-interacting dark matter. Recent measurements on the aftermath of galaxy cluster collisions allow us to constrain the value of the thermally averaged cross section $\crosssection$ of this self-interaction, thus motivating the development of dark matter \emph{collisional} simulations.

On the other hand, Lattice Boltzmann simulations have been widely used to recreate increasingly complex fluids and boundary conditions, nonetheless, the usual Lattice-Boltzmann scheme does not simulate the entirety of the velocity space, but simply a small number of adventive velocities.

In this work we implement a Lattice Boltzmann simulation of a collisional fluid. We implement a Lattice-Boltzmann simulations of the phase space of a \emph{collisional} one dimensional dark matter fluid. For the collisional step, we use the BGK approximation modeled by a relaxation time $\tau$ chosen accordingly to recent estimates of the $\crosssection$.
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
%TODO confirmar todas las keywords con Jaime
%keyword1 -- keyword2 -- keyword3
gravitation -- methods: numerical -- stars: kinematics and dynamics -- galaxies: kinematics and dynamic -- (cosmology:) dark matter
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}
%Conventionally, dark matter is simulated with N-body schemes that sample the phase space in order to solve the Poisson-Vlasov equation. This approach is heavily motivated by the $\Lambda$CMD cosmology, in which dark matter is a cold collisionless fluid. 
%However, there is some evidence pointing towards self-interacting dark matter. Recent measurements on the aftermath of galaxy cluster collisions allow us to constrain the value of the thermally averaged cross section $\crosssection$ of this self-interaction, thus motivating the development of dark matter \emph{collisional} simulations.\\

In 2017 \citet{integerLatticeDynamics} reintroduced a method originally proposed by \citet{latticeStellarDynamics} to simulate the evolution of the phase space of a collisionless stellar fluid. Their proposed method was sympletic, as defined in \citet{1992PhyD...56....1E}; Lagragian; conservative; non-diffusive and time-reversible.
The method consisted of solving the Poisson equation to calculate the gravitational potential at every time step, and then shifting density packets on the phase space lattice using a direct integration Euler scheme to calculate the new positions. 
The direct integration does not suffer from rounding error because of the use of integer arithmetic to update the positions on the phase space; however, the rounding of the acceleration does introduce an error, which is reduced as the resolution of the simulation increases. 
Overall, this method solves the discrete collisionless Boltzmann equation coupled with the discrete Poisson equation, but in the limit of high resolution, it converges to their continuous variants. 
Additionally, \citeauthor{integerLatticeDynamics} compared the method with traditional approaches such as N-body simulations using particle mesh, or finite volume schemes using a moving mesh; and found that their method is a very computationally cheap alternative, and considerably better at resolving fine structure in the phase space.
The main drawback of the method comes from the memory requirements of the direct integration, as it scales as $N_x^D N_v^D$, where $D$ is the number of spatial dimensions. In this work we used $D = 1$. Thus allowing for a very high resolution.

On the other hand, Lattice Boltzmann methods (LBM) solve the discrete Boltzmann equation by dividing it in two different steps: the streaming step, where the phase space lattice is updated according to the collisionless Boltzmann equation; and the collisional step, where the phase space is updated according to a particular collisional operator, usually the Bhatnagar-Gross-Krook (BGK) operator \citep{1954PhRv...94..511B}. However, the most common approach uses only a small number of adventive velocities instead of the whole velocity space. 
The method reintroduced in \citet{integerLatticeDynamics} can be interpreted as the streaming step of a LBM, but using the entire velocity space, instead of a few adventive velocities.

Here, we extend \citeauthor{integerLatticeDynamics} method by adding a collisional step modeled by the BGK operator. The result is a LBM that is capable of simulating stellar fluids regardless of their collisional nature. 
%We tested the method for a collisional dark matter fluid; in order to avoid any compromise in the nature of the dark matter particle -- in particular its mass and thermally averaged cross-section $\crosssection$ --
%TODO añadir la parte de materia oscura
Among the possible fluids to simulate, weakly interacting dark matter is one of the most interesting.
%On the other hand, \citet{integerLatticeDynamics} method is essentially the streaming step of a Lattice Boltzmann simulation but using the entire velocity space, instead of a few adventive velocities . Here, we extend the method by adding a collisional step, allowing to solve the Boltzmann equation for a self-gravitating fluid, regardless of its collisional nature. We make use of the Bhatnagar-Gross-Krook (BGK) operator \citep{1954PhRv...94..511B} to model the collisional step, as it does not make assumptions on the nature of the short range interactions dominating the collisions.

%All papers should start with an Introduction section, which sets the work
%in context, cites relevant earlier studies in the field by \citet{Others2013},
%and describes the problem the authors aim to solve \citep[e.g.][]{Author2012}.

\section{The Boltzmann Equation}
The state of a stellar fluid can be described by the phase space density $\f$, which gives the mass of stellar fluid in the position $\vb*{r}$ with velocity $\vb*{v}$. The mass density is calculated by integration of the phase space density over the entire velocity space:
\begin{equation}
\dens = \int \f \dd[3]{\vb{v}}.
\end{equation}
The evolution of the phase space density is modeled by the Boltzmann equation:
\begin{equation}
\pdv{f}{t} + \vb*{v} \cdot \pdv{f}{\vb*{x}} - \pdv{\Phi}{\vb*{x}} \cdot \pdv{f}{\vb*{v}}  = C[f]  \text{.}
\end{equation}
The homogeneous solution to the left hand side corresponds to the collisionless Boltzmann equation -- also known as the Vlasov equation --, which is often used to simulate self-gravitating collisionless stellar systems \citep*{2001NewA....6...79S, 2013ApJ...762..116Y,2016MNRAS.455.1115H, integerLatticeDynamics}.
The right hand side corresponds to the collisional operator, and quantifies the effect of collisions during the evolution of the phase space.
A complete modeling of the collisional operator requires knowledge of the short range interactions between particles, given that we do not know the short range interaction of a dark matter particle, we work with approximation schemes such as the BGK approximation.
The BGK operator quantifies collisions as a relaxation process towards \emph{local equilibrium} modeled by a relaxation time $\tau$:
\begin{equation}
C[f] = -\frac{(f-f_e)}{\tau} \text{,}
\end{equation}
Where $f_e$ represents the local equilibrium distribution. In this work we use a Maxwell-Boltzmann equilibrium. The details of the implementation are expanded in \ref{bgk}.

Lastly, in order to account for the gravitational interaction, the Boltzmann equation is coupled with the Poisson equation:
\begin{equation}
\laplacian \pot = 4 \pi G \dens .
\end{equation}
\section{Lattice Boltzmann Method (LBM)}
\label{boltz}
The Lattice-Boltzmann method divides the phase space density into a lattice, and solves the discrete Boltzmann equation in two steps: the free streaming step (Section \ref{sec: streaming}), and the collisional step (Section \ref{sec: collisional}).

\subsection{Streaming step}
\label{sec: streaming}
In the lattice, $\f\Delta\vb{r} \Delta\vb{v}$ corresponds to the mass of fluid with positions in the range $[\vb*{r}, \vb*{r}+\Delta\vb*{r}]$ and velocities in the range $[\vb*{v}, \vb*{v}+\Delta\vb*{v}]$, where $\Delta\vb{r}$ and $\Delta \vb*{v}$ is the separation between lattice nodes for the position and velocity dimensions respectively. The boundary values of the phase space and set of physical units are chosen particularly for each system to simulate.

We initialize the phase space according to the system of interest. Then, integrate the velocity space to obtain the density profile. Due the lattice, integration become a sum over the entire velocity grid: $\dens = \sum_{\vb*{v}_{min}}^{\vb*{v}_{max}} \f \Delta \vb*{v}$. With the physical density profile, we solve the Poisson equation using the pseudo-spectral method, as proposed in \citet{2014arXiv1409.8116F}, with the FFTW implementation of the Fast Fourier Transform \citep{FFTW}. We perform a numerical derivative on the gravitational potential to obtain the acceleration profile and from then, we can proceed to update the phase space lattice. Due the discretization, we can use integer numbers to represent every lattice node without loss of generality. Thus the new positions on the phase space lattice are given by:
%TODO confirmar con Jaime que gather es permitido.
\begin{gather} 
\vb*{v}(t+\Delta t) = \vb*{v}(t) + \toInt{\vb*{a}(t) \Delta t}\text{,} \\
\vb*{r}(t+\Delta t) = \vb*{r}(t) + \toInt{\vb*{v}(t) \Delta t}\text{,} 
\end{gather}
where $\toInt{.}$ represents the "to integer" operator. 
The complete streaming step is given by:
\begin{equation}
f(\vb*{r}(t+\Delta t),\vb*{v}(t+\Delta t);t+\Delta t) = \f\text{.}
\end{equation}
Once updated the phase space, we recalculate the density. If we are simulating a collisionless fluid, we can solve the Poisson equation and continue the loop.  
\subsection{Collisional step}
\label{sec: collisional}
The BGK collisional step is defined by 
\begin{equation}

\end{equation}

%TODO decidir si dejo los comentarios de la discretización y de los problemas del método para el final de esta sección o los incluyo apenas hablo de discretizar.
The main effect of the discretization of the phase space is that we no longer use the entire phase space, but a discrete number of velocities and positions, which allows for the use of integer arithmetic when updating the lattice. This eliminates the floating point error but introduces lattice noise during the discretization of the acceleration. In the limit of high resolution, the absence of floating point error and the tendency of the lattice noise towards zero guarantees that the method converges to the continuum solution of the Boltzmann equation. Overall, the algorithm recovers the Euler-Lagrange equations and conserves mass, momentum and energy.

However, this method has one big drawback. The time evolution of the phase space is calculated using a direct integration scheme, which implies that for a simulation with $N$ spatial dimensions each one having size $n$, we would need to store $n^{2N}$ cell units per timestep. This is in fact a very heavy constrain because most cases of interest are three dimensional. For example, in a three dimensional distribution, if the grid size were to be $64$, then we would need almost 600 Gigabytes of memory just to store the lattice. 
The specifics of implementing a Lattice Boltzmann method are discussed further in section \ref{implementBoltzmann}.



\section{BGK Approximation}
\label{bgk}
The main challenge when solving the Boltzmann equation is the collisional operator. Modeling a collisional operator and solving the subsequent integral is not a straightforward procedure, which is why simpler alternatives have been widely considered.

The Bhatnagar–Gross–Krook approximation was proposed in 1954 \cite{1954PhRv...94..511B} in order to simplify the collision integral.
The approximation operates under the assumption that the large amount of detail involved in the two-body interactions are not likely to significantly influence the macroscopic variables\cite{asinari}.
This is known as an mesoscopic approach, because we disregard the microscopic interactions while preserving the macroscopic properties of the system. 
The scheme ignores the specifics of the two-body interactions but keeps the tendency of the system towards local equilibrium and then global equilibrium.

Local equilibrium is defined by the following condition:
\begin{equation}
C[f_e] = 0\text{.}
\end{equation}
Which simply states that in \emph{local equilibrium}, the collisions do not affect the time derivative of the distribution function. Note that local equilibrium does not mean that the macroscopic variables of the system are constant in space and time, but that the local value of  $\f$ corresponds to the local value of $f_e(\rv)$, for an appropriate equilibrium distribution function $f_e(\rv)$. Finally, the BGK operator can be stated as:
\begin{equation}
C[f] = -\frac{1}{\tau}(\f - f(\rv)) \text{,}
\end{equation}


where $\tau$ is a characteristic relaxation time for the system. In most cases, the equilibrium function obeys the Maxwell-Boltzmann distribution, however, Fermi-Dirac distributions were widely used in the early years of the Lattice Boltzmann methods.
In recent years modified Maxwellians have been proposed to extend the BGK scheme to the quantum realm\cite{2010arXiv1009.3352F} and to include annihilation and creation of particles. The specifics of our implementation of the BGK approximation are discussed in section \ref{metodologiaBGK}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%TODO Explicar brevemente el algoritmo y hablar detelladamente del paso colisional.
\section{The Lattice Boltzmann Algorithm}
\section{General Description}
\label{implementBoltzmann}
The heart of the Lattice-Boltzmann algorithm is the discretization of the phase space\cite{integerLatticeDynamics} \cite{franco}.

To discretize the phase space, we must choose the region to simulate. In this work, we name the extremal values in the $w$ axis of the phase space $W_{min}$ and $W_{max}$.
Then, one has to fix either the size of the grid or the size of the lattice.
We name the size of the grid in the $w$ axis $N_w$ (i.e. $N_x$ or $N_{vz}$).
The size of a lattice unit in the $w$ axis (which we are going to name $dw$) and the extremal values are related by
\vspace{1mm}
\begin{equation}
dw = \frac{W_{max}-W_{min} }{N_w}.
\end{equation}%\vspace{1mm}
In this work use the phase space mass density, which means that $\f \dd \vb{r} \dd \vb{v}$ is the \emph{mass} of dark matter whose position is between $\vb{r}$ and $\vb{r} + \dd \vb{r}$, and its velocity is between $\vb{v}$ and $\vb{v} + \dd \vb{v}$.
Now that we have properly defined the grid, we must initialize the phase space. The initial conditions are discussed in detail in section \ref{initialConditions}.

After initialization, the phase space evolves by the action of the Louville operator and the Collisional operator. However, the collisions are modeled as instantaneous, which allows us to concentrate they entire influence in a single collisional step per time step. %The schematics of the algorithm can be seen in figure  \ref{flowchart}.



After having initialized the phase space, we can obtain the spatial density of matter by numerical integration in the velocity space
\begin{equation}
\label{defDens0}
\dens[t] = \int_{-\infty}^{\infty} \! \f[t] \, \dd \vb{v}.
\end{equation}
When evaluating in the lattice the integral becomes a sum over the entire velocity lattice
\begin{equation}
\label{defDens}
\dens[t] = \sum_{\vb{V}_{min}}^{\vb{V}_{max}} \f[t] \, \dd \vb{v},
\end{equation}
and during initialization
\begin{equation}
\dens[0] = \sum_{\vb{V}_{min}}^{\vb{V}_{max}} \f[0] \, \dd \vb{v}.
\end{equation}
Once we have calculated the density, we solve the Poisson equation to obtain the potential due the gravitational interaction	\cite{integerLatticeDynamics}
\begin{equation}
\laplacian \pot = 4 \pi G \dens .
\end{equation}
\begin{equation}
\laplacian \pot = 4 \pi G \dens .
\end{equation}

%TODO añadir 
Where $\pot$ is the gravitational potential and $G$ is the gravitational constant.
To solve the Poisson equation we use the Fourier pseudo-spectral method, which allows for very fast numerical solutions by making use of the Fast Fourier Transform algorithm. We apply a Fast Fourier Transform (FFT) to the density, then solve the equation in the Fourier space, and then apply an inverse transform (IFFT). In the Fourier space the Poisson equation is given by\cite{freePoisson} \cite{computerUsingParticles}
\begin{equation}
\lambda_{\vb{k}}^2 \hat{\Phi}(\vb{k},t) = 4 \pi G \hat{\rho}(\vb{k},t).
\end{equation}
Where $\hat{g}(\vb{k},t)$ is the Fourier transform of $g(\vb{r},t)$, and $\lambda_{\vb{k}}$ is a constant that depends on the size of the lattice and the wave vector $\vb{k}$.
$\lambda_{\vb{k}}$ is calculated according to the approximation scheme used to solve the equation.
In the the pseudo-spectral approximation, $\lambda_{\vb{k}}$ is given by \cite{freePoisson}:
\begin{equation}
\lambda_{\vb{k}}^2 = -\qty(\frac{2 \pi k_x}{X_{max} - X_{min}})^2 + \qty(\frac{2 \pi k_y}{Y_{max} - Y_{min}})^2 + \qty(\frac{2 \pi k_z}{Z_{max} - Z_{min}})^2.
\end{equation}
Therefore, solving the Poisson equation in the Fourier space is reduced to simple arithmetic.
Thanks to the highly efficient implementations of the Fast Fourier Transform Algorithm available nowadays, solving the Poisson equation takes very little time and computational resources.
In this work we use the Fastest Fourier Transform of the West\cite{FFTW} subroutine to handle the Fast Fourier Transforms.

Afterwards we compute the acceleration
\begin{equation}
\acce = -\grad \pot.
\end{equation}
We use a central difference numerical derivative in our implementation.

Now, in order to update the phase space, we must first define the time interval to simulate: we name $N_t$ the number of time \emph{instants} to simulate and $\dd t$ the length of each of such instants.
After calculating the acceleration and defining $\dd t$, we can update our phase space.
As mentioned in section \ref{boltz}, the subtlety here is that we will only use integer arithmetic, which means that we do not exactly care about the change in velocity during a time $\dd t$, but for how many cells in the phase space lattice that change represents. This is modeled by
\begin{equation}
\vb{v}_{n+1} = \vb{v}_n + \toInt{\vb{a}_n \dd t}.
\end{equation}
With $\toInt{x}$ representing the operator \tqt{to nearest integer}, so that $\vb{v}$ and $\toInt{\vb{a} \dd t}$ are vectors of integers and $n$ represents the time instant. The update of the velocity is known as \tqt{kick}. Analogously, the update of the position is known as \tqt{drift}, and is given by
\begin{equation}
\vb{r}_{n+1} = \vb{r}_n + \toInt{\vb{v}_n \dd t}.
\end{equation}
The use of only integer arithmetics allows for the elimination of the rounding error but introduces lattice noise. Regardless, this method creates a one to one map with the continous solution \cite{integerLatticeDynamics} \cite{franco}.
The \tqt{kick} and \tqt{drift} together are known as the \tqt{Streaming} step, and it represents the classical movement of particles under a potential but without considering the collision of particles. 
In a collisionless simulation we can just calculate again the density and continue the algorithm from there. For a collisional simulation, we must define a collisional step.

\section{The Collisional Step}
\label{metodologiaBGK}
Solving the collisional integral $C[f]$ is not a straight-forward task, as it depends on the modeling of the short range interactions that we decide to assign to the dark matter particle.
Given that the short range interactions of dark matter are unknown, we avoid using an specific description of the microscopic interactions and choose to use a mesoscopic approach instead, as discussed in section \ref{bgk}. The BGK collisional operator is given by
\begin{equation}
C[f] = -\frac{1}{\tau}(\f - f_e(\rv)),
\end{equation}
which in the context of the direct integration scheme used in the simulation becomes
\begin{equation}
f(\vb{r} + \vb{v} \dd t,\vb{v},t) = \f - \frac{\dd t}{\tau}(\f - f_e(\rv)).
\end{equation}\\
The idea behind this approach is to recover the macroscopic properties of the fluid without committing to a particular microscopic description. In this scenario, the macroscopic effects of the collisions is a local relaxation towards equilibrium, which the BKG operator models using a relaxation time $\tau$ and a local equilibrium distribution $f_e(\rv)$. 

We implement the collisional operator as a collisional step after the streaming step, in which the system performs a relaxation with characteristic (relaxation) time $\tau$ towards the local equilibrium distribution $f_e(\rv)$. 
It is important to note that the BGK collisional operator is a \emph{scattering} operator and does not consider annihilation or creation of particles. 

After defining the collisional term, we have to choose a distribution function $f_e(\rv)$. We claim that the phase space distribution relaxes towards local equilibrium, which means a displacement in the phase space and not the introduction or annihilation of mass.
Therefore, the equilibrium distribution must be perfectly \emph{normalized}  in order to enforce particle number conservation. We normalize the equilibrium distribution by using macroscopic quantities obtained through numerical integration of the velocity part of the phase space.
This macroscopic quantities are: the spatial density $\dens$, the macroscopic velocity $\vb{u}(\rv)$ and the internal energy $e(\rv)$.

The volumetric density is the same density we have been using so far defined by the integral of equation \ref{defDens0}. The macroscopic velocity $\vb{u}(\rv)$ is defined by the integral
\begin{equation}
\vb{u}(\rv) = \int_{-\infty}^{\infty} \! \f[t] \, \vb{v}  \dd \vb{v},
\end{equation}

when evaluating in the lattice the integral becomes
\begin{equation}
\label{defVel0}
\vb{u} = \sum_{\vb{V}_{min}}^{\vb{V}_{max}} \f[t] \,  \vb{v} \dd \vb{v}.
\end{equation}
The internal energy is defined by the integral
\begin{equation}
e(\rv) = \frac{1}{2} \int_{-\infty}^{\infty} \! \f[t] \, (\vb{v} -\vb{u})^2 \dd \vb{v}.
\end{equation}
Which also becomes a sum when evaluating in the lattice
\begin{equation}
\label{defEn0}
e(\rv) = \frac{1}{2} \sum_{\vb{V}_{min}}^{\vb{V}_{max}} \f[t] \,  (\vb{v} -\vb{u})^2 \dd \vb{v}.
\end{equation}\\%\vspace{2mm}
Note that we are not including explicitly the mass of the dark matter particle in this integrals because it has already been included in the definition of the phase space.

Now that we have well defined macroscopic variables, we can proceed to choose an equilibrium distribution. Such distribution must obey the following condition
\begin{equation}
C[f_e] = 0.
\end{equation}
Which simply means that if the system is already in local equilibrium, then there is no relaxation. This condition can also be stated as \tqt{the equilibrium function must be a collisional invariant}. In order for $f_e(\rv)$ to be a collisional invariant, it must be build with variables that are also collisional invariant. Fortunately, the macroscopic variables already defined in this chapter are also collisional invariants, and so, we can use them to build equilibrium distributions. The idea behind normalization is to obtain the same macroscopic variables when integrating over $f_e(\rv)$ instead of $\f$.  In this work we use distributions based on the Maxwell-Boltzmann velocity distribution. Alternative equilibrium distributions functions can be considered and may be of interest, but they are beyond the scope of this work. In particular, quantum Maxwellians may be used to include annihilation and creation of particles, and the effects of Bose-Einstein, Fermi-Dirac statistics\cite{2010arXiv1009.3352F}.\vspace*{5mm}\\
The equilibrium function to use is a classical Maxwellian properly normalized for the case of interest
\begin{equation}
f_e(\rv) = \frac{\rho}{[2 \pi \ e(\rv) ]^{D/2}} \exp[-\frac{(\vb{v}-\vb{u})^2}{2 \ e(\rv)}].
\end{equation}\\
Where $D$ is the number of spatial dimensions. For example, if the system is a three dimensional dark matter halo, then D will be equal to three.
The Maxwell distribution was originally used to describe the probability distribution of the velocity in a gas under kinetic theory assumptions. Here, we assume collisions as a phenomena that happens instantly. During the time in between, the mechanics of the system are governed by the self-gravitational potential. Therefore, the Maxwell distribution is a good ansatz for the collisional equilibrium distribution function $f_e(\rv)$. \\
Finally, the only thing left to choose is a relaxation time. As in classic kinetic theory, our relaxation time will be given by
\begin{equation}
\tau = \frac{1}{n \crosssection}.
\end{equation}
In terms of the matter density instead of particle number it becomes
\begin{equation}
\tau = \frac{m}{\rho \crosssection},
\end{equation}
with $n$ being the mean particle number in the halo, $m$ being the mass of a dark matter particle, $\rho$ being the average density of a dark matter halo and $\crosssection$ is the thermally averaged cross-section of the particle.\\
For this simulation we use the average \emph{matter} density of the universe, given by the most recent results of the Planck probe\cite{2018arXiv180706209P}. We are also going to use the value of $\crosssection$  constrained by the Bullet Cluster data \cite{2008ApJ6791173R} \cite{2017MNRAS465569R}, and for the dark particle mass we are going to use the lowest mass possible for a fermionic dark matter particle candidate \cite{mariangela}. These values are:
%TODO volver esto una tabla.
%\begin{align}
%m &= 0.7 \ \text{KeV} \\
%\crosssection &= 3 \e{-26} \ \text{cm}^3 / \text{s}\\
%\rho = \Omega_m &= 0.312  
%\end{align}
The final value of $\tau$ will depend on the particular set of units used in every scenario. Alternative set of values may be used to test dark matter particle candidates.

\subsection{Parameters of the simulation}
%TODO borrar esta sección, mencionar los parámetros al hablar de cada condición simulada.
There are still a few important aspects of the simulation still to be defined: the units, the boundary conditions and the grid parameters.

To set the units we fix the value of one spatial unit ($us$), one unit of time ($ut$), and one unit of mass ($um$) of the simulation, and from there, we proceed to calculate the values of the physical constants in our units. 
The physical constants of interest here are the gravitational constant, and the relaxation time $\tau$ used in the collisional step.
We chose units to simulate a dark matter halo of dimensions akin to the halo of some galaxies of the Local Group. Because of stability conditions, the units may differ between runs. 
The complete set of units used in the work is presented in the following table, where we use $t_0$ to represent the age of the universe:



\begin{table}
    \centering
    \label{otraTablaDelSuicidio}
	\begin{tabular}{|c|c|c|c|c| }
	\hline 
	No. of axes & 1 us [kpc] & 1 ut [$t_0$] & 1 um [10$^{11}$ $M_{\odot}$] & $\tau$ [ut] \\ \hline
	2 & 35 & 0.004 &  1 & 8972 \\ \hline
	\end{tabular}
\end{table}


For the boundaries we implement the following conditions:
\begin{itemize}
\item The boundaries of the spatial axes are periodic. Any portion of mass that leaves the distribution, will re enter through the opposite extreme. This condition assumes the system as periodic.
\item Every portion of mass that leaves the distribution through the velocity axes will be lost forever. That means that if a particle has a velocity higher than the extremal values of the simulation, the particles is no longer considered in the next time step. This condition is not very limiting because we have high extremal values for the velocity and dark matter is traditionally modeled as \emph{cold} or \emph{warm}.
\end{itemize}

To set the grid parameters we must know how much memory is available. Increasing the number of dimensions increases also the amount of memory used to save the lattice, and therefore, reduces the size of the grid. In the following table we present the values that characterize the grids used in this work:


\begin{table}
    \centering
    \label{otraTablaDelSuicidio}
	\begin{tabular}{|c|c|c|c|c|c| }
	\hline 
No. of axes &$W_{min}$ [us] & $W_{max}$ [us] & $N_w $ & dw [1/us] & dt [ut] \\ \hline
	2 & -1 & 1&  2048 & 1/1024 & 0.4 \\ \hline
	\end{tabular}
\end{table}
We always use grid sizes in the form $2^n$ with $n$ positive integer, because the Fast Fourier Transform algorithm performs better and faster when calculating discrete transforms of sizes $2^n \ 3^m \ 5 ^l$ for $n,m,l$ positive integers.


\section{The Bullet Cluster}
\label{bulletExplain}
Galaxy clusters have three main constituents: dark matter, intracluster gas (which is mostly ionised hydrogen and helium), and the galaxy themselves \cite{book:75345}.

We can observe the intracluster baryonic matter in the X-ray band thanks to Bremsstrahlung radiation, therefore, by doing photometry in X-ray it is possible to map the baryonic gas distribution in a cluster.
In the case of dark matter, we infer its existence in clusters thanks to the work of Fritz Zwicky and the posterior work in the missing mass problem in galaxy clusters.
Our current estimates place most of the cluster mass in the dark matter component.
By analyzing the gravitational lensing effect (in particular the \emph{weak} gravitational lensing effect) it is possible to map the mass distribution of a galaxy cluster. 
Lastly, we can observe the galaxies in the visual and the infrared band.
They are the only component of a galaxy cluster that can be observed in the visual band.
About 90 percent of the mass of a cluster is dark matter (this is not a surprise since Fritz Zwicky measured mass-to-light ratios of 50 during the 1930s). Of the remaining baryonic matter, the ionized gas mass can represent up to 90$\%$ of the baryonic mass, making galaxies responsible for about 1$\%$ of the total cluster mass.

The object Bullet Cluster (also known as 1E 0657-558) is the aftermath of the collision of two galaxy cluster.
Before the collision, each cluster had its own baryonic gas, dark matter and set of galaxies, and the centroid of each constituent coincided with the centre of mass of the whole cluster.
During the collision, each constituent reacts differently to the situation:
\begin{enumerate}
\item Galaxies, given that they occupy a minuscule fraction of the total volume of the cluster, are essentially collisionless. Two galaxy clusters can collide without any galaxy (or very little galaxies) colliding per se. 
\item Dark matter is also modeled as collisionless, therefore, during the collision of two galaxy clusters, the dark matter components simply pass through, similarly to how Neutrinos constantly cross the Earth without losing a significant amount of energy.
\item The baryonic gas on the other hand is collisional, and its short range interactions are very well described by the Standard Particle Model. During the galaxy cluster collision, the baryonic parts interact and they lose energy through particle collision. This interaction decouples the baryonic gas from the galaxies and dark matter, and, given that we can directly observe the hot gas (thanks to X-ray astronomy), we can measure the separation between the centroid of the hot gas and the centroid of the galaxies.
\end{enumerate}

If there was no dark matter, then after the collision the weak lensing mapping of the mass distribution would be very close to the hot gas distribution, because the hot gas would be the dominant mass density in the cluster. If dark matter were to exists, then it would dominate the mass density distribution in the galaxy cluster and the weak lensing mapping would be very similar to the galaxies distribution (because they are also collisionless).

What we observe in the Bullet Cluster is the latter case, in which hot gas decouples from dark matter and galaxies.
By mapping the cluster components and measuring the difference between the centroids, it was concluded that there is a dark matter component in the clusters.
Very accurate measurements and estimates of the centroids show a small collisional nature in the dark matter component, such measurements allows to estimate the \emph{thermally averaged cross-section} of the dark matter particle ( $\crosssection$ ).
Therefore, it is worth exploring the collisional dark matter scenario.


\section{Initial Conditions}
\label{initialConditions}
We made use of different initial conditions depending on the objective of each run of the simulation. For the two dimensional phase space we had three initial conditions: Gaussian distribution, Jeans instability and Bullet Cluster-like scenario.
For the four and six dimensional phase space we only used Gaussian initial conditions.

The Gaussian initial conditions are given by
\begin{equation}
\f[0] = A \exp(-\frac{\vb{r}^2}{\sigma_r^2}-\frac{\vb{v}^2}{\sigma_v^2}).
\end{equation}
Where $\f[0]$ is the initialization of the phase space density, A is an indirect measure of the total mass in the system, and $\sigma_i$ are a measure of the width of the Gaussian profile in the given axis. Note that we use a single width for the spatial axes ($\sigma_r$) and a single width for the velocity axes ($\sigma_v$). The specific values for the parameters are presented in the following table:


\begin{table}[htb]
    \centering
    \label{tablaDelSuicidio}
	\begin{tabular}{|c|c|c|c|c| }
	\hline
	No. of axes & A & $\sigma_r$ [us] & $\sigma_v$ [us/ut] & Total mass [10$^{10}$ $M_{\odot}$] \\ \hline
	2 & 40 um us$^-1$ (us/ut)$^-1$ & 0.06 & 0.06 & 0.9  \\ \hline
	\end{tabular}
\end{table}

The total mass of the two dimensional run is in accordance with recent estimates of the total mass of the Small Magallanic Cloud \cite{2009MNRAS395342B}. Likewise, the four dimensional case is similar in total mass to the Triangulum Galaxy(M 33)\cite{2003MNRAS342199C} , and the six dimensional case is also similar to the Small Magallanic Cloud.\vspace*{5mm}\\
The Jeans instability initial conditions are given by 
\begin{equation}
f(r,v,0) = \frac{\bar{\rho}}{(2 \pi \sigma^2)^{1/2}} \exp(-\frac{v^2}{2 \sigma^2}) (1 + A \cos(kr)).
\end{equation}
Such that $\bar{\rho}$ is the average phase density of the system, $\sigma^2$ is the variance of the velocity Gaussian profile, $A$ is the amplitude of the density fluctuation and $k$ is the wave number of the density fluctuation. The values used were:
\begin{align}
\bar{\rho} &= 10 \  \text{um} \ \text{us}^{-1} \ (\text{us/ut})^{-1} \\
\sigma &= 0.1 \ \text{us/ut} \\
A &= 0.9999 \\
k &= 2 \pi \ \text{us}^{-1}
\end{align}
And last, the Bullet Cluster-like scenario, in which two Gaussian distributions collide due to their gravitational interaction, each Gaussian having its own variance and amplitude.
In the real Bullet Cluster one of the clusters was heavier than the other, therefore, we fix one halo heavier in our simulation.

The initial conditions are given by the function:
\begin{equation}
\f[0] = A_1\exp{-\frac{(x-0.4)^2}{2 \sigma_1^2} - \frac{v^2}{2 \sigma_v^2}} + A_2\exp{-\frac{(x+0.4)^2}{2 \sigma_2^2} - \frac{v^2}{2 \sigma_v^2}}.
\end{equation}
Here $A_i$ is a measure of the total mass of the ith halo, $\sigma_i^2$ is the variance of the Gaussian profile of the halo in the spatial axis, and $\sigma_v^2$ is the variance of the Gaussian profile in the velocity axis. The values used to initialize the simulation were:
\begin{align}
\sigma_1 &= 0.04 \ \text{us} \\
\sigma_2 &= 0.04  \ \text{us} \\
\sigma_v &= 0.06 \ \text{us} \\
A_1 &= 40 \ \text{um} \\
A_2 &= 30  \ \text{um}
\end{align}

\chapter{Numerical Tests}
In order to test the code we ran a few numerical tests using the Gaussian and the Jeans instability initial conditions.
\section{Two dimensional phase space}
We begin with the Gaussian initial conditions because their simplicity and ease to analyze makes them the best introductory example.
The Gaussian initialization can be seen in figure \ref{1dInit}, along with its correspondent spatial density. 
After initialization, we proceed to calculate the potential and the acceleration, which can be seen in figure \ref{1dInit2}.

We reproduced previous work on the collisionless case done by Philip Mocz and Sauro Succi in 2016 \cite{integerLatticeDynamics} and Sebastian Franco in 2017 \cite{franco}
For it, we ran a collisionless simulation and checked upon the behavior of the phase space density, the spatial density, the potential and the acceleration.
In the phase space grid, we observed that the cells with positive velocity moved to the right side of the plot, but, as they moved to the right they were also being attracted towards the left because of the symmetry of the initial conditions. 
Therefore, the cells with positive velocity moved towards the inferior-right side of the plot, while cells with negative velocity moved towards the upper left side of the phase space.

The observed behavior was in complete accordance with previous work and can be seen in figure \ref{1dphase}, where we plot different time instants chosen to display the clockwise spiral of the phase space evolution.

To visualize the linear density, we plot density vs position. We observed an initial increase in the height of the central peak and then little bumps trying to abandon the central distribution as they are gravitationally pulled back before crossing the spatial boundaries of the lattice. The bumps are simply the tails of the velocity distribution. This behavior can be seen in figure \ref{1dDens}

We also reproduced the Jeans instability initial conditions. The parameters of the initialization were chosen to meet the Jeans instability criteria, in which the halos do not collapse but interchange mass with its neighbors.
Each halo also behaves as a clockwise rotating spiral (which is not a surprise given that we used Gaussian initialization for the velocity).
This results was also compatible with previous work. The evolution of the Jeans instability phase space can be seen in figure \ref{1dJeans}.

\begin{figure}
    \centering
    %\includegraphics[width=10cm,height =7cm]{Diapositiva1.jpg}
    \includegraphics[scale=0.45]{images/1dInitPS.png} %TODO cambiar por algo que funcione a escala de grices.
    \includegraphics[scale=0.45]{images/1dInitDens.png}
    \caption{Up: initialization of the phase space. Position is represented in the $x$ axis, and velocity in the $y$ axis of the plot. Down: the spatial density obtained through integration. }
    \label{1dInit}
\end{figure}

\begin{figure}
    \centering
    %\includegraphics[width=10cm,height =7cm]{Diapositiva1.jpg}
    \includegraphics[scale=0.45]{images/gauss8.png}
    \includegraphics[scale=0.45]{images/gauss20.png}
    \includegraphics[scale=0.45]{images/gauss38.png}
    \includegraphics[scale=0.45]{images/gauss81.png}
    \caption{Upper left: Phase space 154 million years after initialization. Upper right: Phase space 484 million years after initialization. Bottom left: Phase space 881 million years after initialization. Bottom right: Phase space 1983 million years after initialization. It is evident that the phase space behaves as a clockwise rotating spiral.}
    \label{1dphase}
\end{figure}
\newpage

\begin{figure}
    \centering
    %\includegraphics[width=10cm,height =7cm]{Diapositiva1.jpg}
    \includegraphics[scale=0.45]{images/gaussD2.png}
    \includegraphics[scale=0.45]{images/gaussD5.png}
    \includegraphics[scale=0.45]{images/gaussD20.png}
    \includegraphics[scale=0.45]{images/gaussD54.png}
    \caption{Upper left: linear density with its central peak at maximum height. Upper right: linear density with its peak at a local minima after having reached maximum height . Bottom left: little bumps can be seen at the tails of the distribution. Bottom right: the tails of the distribution are completely bumpy. These bumps are the same arms observed in the phase space.}
    \label{1dDens}
\end{figure}

\begin{figure}
    \centering
    %\includegraphics[width=10cm,height =7cm]{Diapositiva1.jpg}
    \includegraphics[scale=0.45]{images/jeans7.png}
    \includegraphics[scale=0.45]{images/jeans22.png}
    \includegraphics[scale=0.45]{images/jeans40.png}
    \includegraphics[scale=0.45]{images/jeans90.png}
    \caption{Upper left: Phase space 72 million years after initialization. Upper right: Phase space 227 million years after initialization. Bottom left: Phase space 413 million years after initialization. Bottom right: Phase space 930 million years after initialization. The behavior is the same as three successive Gaussian conditions.}
    \label{1dJeans}
\end{figure}


\section{Methods, Observations, Simulations etc.}

Normally the next section describes the techniques the authors used.
It is frequently split into subsections, such as Section~\ref{sec:maths} below.

\subsection{Maths}
\label{sec:maths} % used for referring to this section from elsewhere

Simple mathematics can be inserted into the flow of the text e.g. $2\times3=6$
or $v=220$\,km\,s$^{-1}$, but more complicated expressions should be entered
as a numbered equation:

\begin{equation}
    x=\frac{-b\pm\sqrt{b^2-4ac}}{2a}.
	\label{eq:quadratic}
\end{equation}

Refer back to them as e.g. equation~(\ref{eq:quadratic}).

\subsection{Figures and tables}

Figures and tables should be placed at logical positions in the text. Don't
worry about the exact layout, which will be handled by the publishers.

Figures are referred to as e.g. Fig.~\ref{fig:example_figure}, and tables as
e.g. Table~\ref{tab:example_table}.

% Example figure
\begin{figure}
	% To include a figure from a file named example.*
	% Allowable file formats are eps or ps if compiling using latex
	% or pdf, png, jpg if compiling using pdflatex
	\includegraphics[width=\columnwidth]{example}
    \caption{This is an example figure. Captions appear below each figure.
	Give enough detail for the reader to understand what they're looking at,
	but leave detailed discussion to the main body of the text.}
    \label{fig:example_figure}
\end{figure}

% Example table
\begin{table}
	\centering
	\caption{This is an example table. Captions appear above each table.
	Remember to define the quantities, symbols and units used.}
	\label{tab:example_table}
	\begin{tabular}{lccr} % four columns, alignment for each
		\hline
		A & B & C & D\\
		\hline
		1 & 2 & 3 & 4\\
		2 & 4 & 6 & 8\\
		3 & 5 & 7 & 9\\
		\hline
	\end{tabular}
\end{table}


\section{Conclusions}

The last numbered section should briefly summarise what has been done, and describe
the final conclusions which the authors draw from their work.

\section*{Acknowledgements}

The Acknowledgements section is not numbered. Here you can thank helpful
colleagues, acknowledge funding agencies, telescopes and facilities used etc.
Try to keep it short.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{bibTes} % if your bibtex file is called example.bib


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

\section{Some extra material}

If you want to present additional material which would interrupt the flow of the main paper,
it can be placed in an Appendix which appears after the list of references.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
